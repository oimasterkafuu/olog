name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    
    steps:
      - name: Extract SSH credentials
        id: ssh_creds
        run: |
          SSH_USER_HOST="${{ secrets.SSH_USER_HOST }}"
          echo "username=${SSH_USER_HOST%@*}" >> $GITHUB_OUTPUT
          echo "host=${SSH_USER_HOST#*@}" >> $GITHUB_OUTPUT
      
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ steps.ssh_creds.outputs.host }}
          username: ${{ steps.ssh_creds.outputs.username }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            
            echo "==> 加载环境变量"
            # 加载用户环境配置
            if [ -f ~/.bashrc ]; then
              source ~/.bashrc
            fi
            if [ -f ~/.profile ]; then
              source ~/.profile
            fi
            
            echo "==> 验证 Node.js 和 npm"
            node --version
            npm --version
            
            echo "==> 进入项目目录"
            cd ~/olog
            
            echo "==> 停止现有 Next.js 进程"
            PID_FILE=~/olog/next-server.pid
            
            # 方案1：从 PID 文件读取进程 ID
            if [ -f "$PID_FILE" ]; then
              OLD_PID=$(cat "$PID_FILE")
              if [ -n "$OLD_PID" ] && kill -0 "$OLD_PID" 2>/dev/null; then
                echo "从 PID 文件发现进程 $OLD_PID，正在终止..."
                kill -TERM "$OLD_PID" 2>/dev/null || true
                sleep 3
                
                # 如果还在运行，强制终止
                if kill -0 "$OLD_PID" 2>/dev/null; then
                  echo "进程 $OLD_PID 未正常停止，强制终止..."
                  kill -9 "$OLD_PID" 2>/dev/null || true
                  sleep 1
                fi
                echo "进程 $OLD_PID 已停止"
              else
                echo "PID 文件中的进程 $OLD_PID 不存在"
              fi
              rm -f "$PID_FILE"
            else
              echo "未发现 PID 文件"
            fi
            
            # 方案2：查找可能残留的 next-server 进程（更精确的匹配）
            # 使用 grep 过滤，避免匹配到 SSH 进程或其他无关进程
            if ps aux | grep -E 'node.*next-server|next start' | grep -v grep | grep -v ssh > /dev/null; then
              echo "发现残留的 next-server 进程："
              ps aux | grep -E 'node.*next-server|next start' | grep -v grep | grep -v ssh
              
              # 逐个终止（更安全）
              ps aux | grep -E 'node.*next-server|next start' | grep -v grep | grep -v ssh | awk '{print $2}' | while read pid; do
                echo "终止残留进程 $pid"
                kill -TERM "$pid" 2>/dev/null || true
              done
              sleep 2
            fi
            
            echo "所有旧进程已清理完毕"
            
            echo "==> 拉取最新代码"
            git pull origin main
            
            echo "==> 安装依赖"
            npm install
            
            echo "==> 运行数据库迁移"
            npx prisma migrate deploy
            
            echo "==> 构建项目"
            npm run build
            
            echo "==> 创建日志目录"
            mkdir -p ~/olog/logs
            
            echo "==> 后台启动服务"
            # 启动服务并保存 PID
            nohup npm run start > ~/olog/logs/output.log 2>&1 &
            echo $! > ~/olog/next-server.pid
            echo "服务已启动，PID: $(cat ~/olog/next-server.pid)"
            
            echo "==> 等待服务启动"
            sleep 5
            
            echo "==> 检查服务状态"
            if [ -f ~/olog/next-server.pid ]; then
              NEW_PID=$(cat ~/olog/next-server.pid)
              if kill -0 "$NEW_PID" 2>/dev/null; then
                echo "✓ 部署成功，服务已启动"
                echo "运行中的进程 (PID: $NEW_PID):"
                ps -p "$NEW_PID" -o pid,ppid,cmd,etime
              else
                echo "✗ 警告：服务启动失败，进程 $NEW_PID 不存在"
                tail -n 50 ~/olog/logs/output.log
                exit 1
              fi
            else
              echo "✗ 警告：未找到 PID 文件"
              tail -n 50 ~/olog/logs/output.log
              exit 1
            fi


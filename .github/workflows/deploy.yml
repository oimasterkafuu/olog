name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    
    steps:
      - name: Extract SSH credentials
        id: ssh_creds
        run: |
          SSH_USER_HOST="${{ secrets.SSH_USER_HOST }}"
          echo "username=${SSH_USER_HOST%@*}" >> $GITHUB_OUTPUT
          echo "host=${SSH_USER_HOST#*@}" >> $GITHUB_OUTPUT
      
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ steps.ssh_creds.outputs.host }}
          username: ${{ steps.ssh_creds.outputs.username }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            
            echo "==> 加载环境变量"
            # 加载用户环境配置
            if [ -f ~/.bashrc ]; then
              source ~/.bashrc
            fi
            if [ -f ~/.profile ]; then
              source ~/.profile
            fi
            
            echo "==> 验证 Node.js 和 npm"
            node --version
            npm --version
            
            echo "==> 进入项目目录"
            cd ~/olog
            
            echo "==> 停止现有 Next.js 进程"
            # 使用 pgrep/pkill 查找并终止 next-server 进程
            if pgrep -f "next-server" > /dev/null 2>&1; then
              echo "发现运行中的 next-server 进程，正在终止..."
              pkill -f "next-server" || true
              sleep 3
              
              # 如果进程仍在运行，强制杀死
              if pgrep -f "next-server" > /dev/null 2>&1; then
                echo "进程未正常停止，强制终止..."
                pkill -9 -f "next-server" || true
                sleep 2
              fi
              
              echo "进程已停止"
            else
              echo "未发现运行中的 next-server 进程"
            fi
            
            # 双重保险：如果 3000 端口仍被占用，使用 fuser 杀死
            if command -v fuser > /dev/null 2>&1; then
              fuser -k 3000/tcp > /dev/null 2>&1 || true
            fi
            
            echo "==> 拉取最新代码"
            git pull origin main
            
            echo "==> 安装依赖"
            npm install
            
            echo "==> 运行数据库迁移"
            npx prisma migrate deploy
            
            echo "==> 构建项目"
            npm run build
            
            echo "==> 创建日志目录"
            mkdir -p ~/olog/logs
            
            echo "==> 后台启动服务"
            nohup npm run start > ~/olog/logs/output.log 2>&1 &
            
            echo "==> 等待服务启动"
            sleep 5
            
            echo "==> 检查服务状态"
            if pgrep -f "next-server" > /dev/null 2>&1; then
              echo "✓ 部署成功，服务已启动"
              echo "运行中的进程："
              ps aux | grep next-server | grep -v grep
            else
              echo "✗ 警告：服务可能未成功启动，请检查日志"
              tail -n 50 ~/olog/logs/output.log
              exit 1
            fi

